<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0e1430">
<title>Femkamp – poängtavla</title>
<style>
  :root{
    --bg:#0b1020; --card:#111831; --muted:#7f8ab3; --ink:#e9edff; --accent:#6aa9ff; --grid:#1b2445;
    --stickTop:56px; /* sätts i JS, används bara på mobil */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    background:linear-gradient(180deg,#0a0f1f, #0e1430 60%, #0a0f1f);
    color:var(--ink);
    display:flex; flex-direction:column; gap:12px;
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
  }
  header{
    padding:12px 12px calc(8px + env(safe-area-inset-top));
    position:sticky; top:0; z-index:4; backdrop-filter:saturate(120%) blur(6px);
    background:rgba(10,15,32,.8); border-bottom:1px solid #151c39;
  }
  header h1{margin:0 0 8px 0; font-size:18px; letter-spacing:.4px}
  .controls{
    display:grid; grid-template-columns: repeat(5, max-content) 1fr;
    gap:8px; align-items:center;
  }
  .controls > *{
    background:var(--card); border:1px solid #22306a; color:var(--ink);
    padding:10px 12px; border-radius:12px; outline:none; font-size:14px; min-height:40px;
  }
  .controls button{cursor:pointer}
  .controls input[type="text"]{width:220px}
  .note{grid-column: 1 / -1; color:var(--muted); font-size:12px}

  /* ====== WRAPPER + TABLE (desktop default) ====== */
  .wrap{padding:0 12px 20px 12px;}
  .table{
    min-width:100%;
    border:1px solid #1a2250; border-radius:14px; overflow:hidden;
    box-shadow:0 10px 30px rgba(0,0,0,.3);
  }
  table{width:100%; border-collapse:separate; border-spacing:0; background:var(--card)}
  thead th{
    background:linear-gradient(180deg,#121b39,#0f1731);
    border-bottom:1px solid #1a2250;
  }
  th, td{
    border-right:1px solid var(--grid); border-bottom:1px solid var(--grid);
    padding:0; text-align:center; vertical-align:middle;
  }
  thead th, tfoot th, tfoot td{padding:10px 8px; font-weight:600; color:#cfe0ff}
  tbody th{
    position:sticky; left:0; z-index:2; background:linear-gradient(180deg,#121b39,#0f1731);
    padding:6px 8px; text-align:left; font-weight:600;
  }
  tbody th .rowMeta{display:flex; gap:6px; align-items:center; flex-wrap:wrap}
  .mode{
    appearance:none; background:#0e1530; color:#cfe0ff; border:1px solid #23336e;
    padding:6px 8px; border-radius:10px; font-size:12px; cursor:pointer;
  }
  .name-input{
    background:#0e1530; border:1px solid #23336e; color:#e6ecff;
    padding:8px 10px; border-radius:10px; width:140px;
  }
  .small{font-size:12px; color:#a9b7e6}
  .ghost{opacity:.7}

  .cell{
    position:relative; height:60px; min-width:68px; cursor:pointer; user-select:none;
    background:
      linear-gradient(135deg, transparent 49.5%, #1b244a 50%, #1b244a 50.5%, transparent 51%),
      linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));
  }
  .cell:hover{outline:2px solid #33418a; outline-offset:-2px}

  /* trianglar – hörnförankrade */
  .tri{ position:absolute; inset:0; display:flex; font-weight:700;
        font-variant-numeric:tabular-nums; pointer-events:none; }
  .tri.score{
    clip-path:polygon(0 0, 100% 0, 0 100%);
    justify-content:flex-start; align-items:flex-start;
    padding:6px 8px; color:#eaf1ff; font-size:18px;
  }
  .tri.rank{
    clip-path:polygon(100% 0, 100% 100%, 0 100%);
    justify-content:flex-end; align-items:flex-end;
    padding:6px 8px; color:#89c2ff; font-size:16px;
  }
  .cell.empty .tri{opacity:.25}

  tfoot td, tfoot th{background:#0e1530;}
  tfoot td.total{font-size:18px; font-weight:800; color:#eaf1ff}

  /* ====== RESPONSIVE ====== */
  @media (max-width: 900px){
    .controls{grid-template-columns: 1fr 1fr; gap:8px}
    .controls > *{width:100%}
    #renameSet{grid-column: span 2}
    .note{grid-column: 1 / -1}
    .name-input{width:120px}
  }
  /* Mobil: aktivera sidledsskroll + sticky header/footer */
  @media (max-width:700px){
    .wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch }
    table{ width:max-content; min-width:100% } /* kan bli bredare än skärmen */
    thead th{ position:sticky; top:var(--stickTop); z-index:3 }
    tfoot th, tfoot td{ position:sticky; bottom:0; z-index:2; background:#0e1530 }
  }
  @media (max-width: 600px){
    header h1{font-size:16px}
    .name-input{width:clamp(84px, 32vw, 110px); font-size:13px; padding:6px 8px}
    .mode{font-size:12px; padding:5px 8px}
    .cell{height:52px; min-width:56px}
    .tri.score{font-size:16px; padding:4px 6px}
    .tri.rank{font-size:14px; padding:4px 6px}
    thead th, tfoot th, tfoot td{padding:8px 6px}
  }
</style>
</head>
<body>
  <header>
    <h1>Femkamp – poängtavla</h1>
    <div class="controls">
      <button id="addPlayer">+ Lägg till spelare</button>
      <button id="addEvent">+ Lägg till gren</button>
      <button id="resetScores" class="ghost">Nollställ resultat</button>
      <input id="renameSet" class="ghost" type="text" placeholder="Döp tävlingen (valfritt)" />
      <span class="note">Tips: klicka i en ruta för att mata in poäng. Vänster triangel = resultat, höger = placeringspoäng.</span>
    </div>
  </header>

  <div class="wrap">
    <div class="table">
      <table id="board"></table>
    </div>
  </div>

<script>
/* ----- Sticky-offset dynamiskt (mobil) ----- */
function setStickTop(){
  const h = document.querySelector('header')?.getBoundingClientRect().height || 56;
  document.documentElement.style.setProperty('--stickTop', `${Math.round(h)}px`);
}
window.addEventListener('resize', setStickTop);
window.addEventListener('orientationchange', setStickTop);
document.addEventListener('visibilitychange', setStickTop);
document.addEventListener('DOMContentLoaded', setStickTop);

/* -------------------- Data Model -------------------- */
const state = {
  title: "Femkamp",
  players: ["P","B","S","F","V"],
  events: [
    { name:"Gren 1", mode:"max", scores:Array(5).fill(null) },
    { name:"Gren 2", mode:"max", scores:Array(5).fill(null) },
    { name:"Gren 3", mode:"max", scores:Array(5).fill(null) },
  ]
};

/* -------------------- Utilities -------------------- */
// Rank-poäng: N för bästa, N-1 osv. Ties => medelvärde av bundna poäng.
function rankPoints(event, playerCount){
  const N = playerCount;
  const vals = event.scores.map((v,i)=>({i, v}));
  const present = vals.filter(x => typeof x.v === 'number' && !Number.isNaN(x.v));
  if (present.length === 0) return Array(N).fill(null);

  present.sort((a,b) => event.mode === 'min' ? a.v - b.v : b.v - a.v);

  const pts = Array(N).fill(null);
  let r = 0;
  while (r < present.length){
    let s = r+1;
    while (s < present.length && present[s].v === present[r].v) s++;
    const size = s - r;
    let sum = 0;
    for (let k=0;k<size;k++) sum += (N - (r+k));
    const avg = sum / size;
    for (let k=r;k<s;k++) pts[present[k].i] = avg;
    r = s;
  }
  return pts;
}
const fmt = (x) => (x==null || Number.isNaN(x)) ? "" : (Number.isInteger(x) ? x : (+x.toFixed(1)));

/* -------------------- Rendering -------------------- */
const el = (tag, attrs={}, ...children) => {
  const n = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)){
    if (k === 'class') n.className = v;
    else if (k === 'html') n.innerHTML = v;
    else if (k.startsWith('on') && typeof v === 'function') n.addEventListener(k.substring(2), v);
    else n.setAttribute(k, v);
  }
  for (const c of children) n.append(c);
  return n;
};

function render(){
  document.title = state.title || "Femkamp – poängtavla";
  const board = document.getElementById('board');
  board.innerHTML = "";

  const playerCount = state.players.length;

  // THEAD
  const thead = el('thead'); const hr = el('tr');
  hr.append(el('th', {}, "")); // hörncell
  state.players.forEach((name,pi)=>{
    const nameInput = el('input', {
      class:'name-input', value:name,
      oninput: e=>{ state.players[pi] = e.target.value; }
    });
    hr.append(el('th',{}, nameInput));
  });
  thead.append(hr);

  // TBODY
  const tbody = el('tbody');
  state.events.forEach((ev,ri)=>{
    const tr = el('tr');

    const nameInput = el('input', {
      class:'name-input', value:ev.name,
      oninput:e=>{ ev.name = e.target.value; }
    });
    const modeSel = el('select', {
      class:'mode',
      onchange:e=>{ ev.mode = e.target.value; render(); }
    },
      el('option', {value:'max'}, 'Flest vinner'),
      el('option', {value:'min'}, 'Minst vinner')
    );
    modeSel.value = ev.mode;
    const removeBtn = el('button', {class:'ghost small', onclick:()=>{
      state.events.splice(ri,1); render();
    }}, "Ta bort");
    const head = el('th',{}, el('div', {class:'rowMeta'}, nameInput, modeSel, removeBtn));
    tr.append(head);

    const pts = rankPoints(ev, playerCount);
    for (let pi=0; pi<playerCount; pi++){
      const score = ev.scores[pi];
      const cell = el('td', {});
      const clickable = el('div', {class:'cell' + (score==null?' empty':''), onclick:()=>{
          const val = prompt(`${ev.name} – poäng för ${state.players[pi]}:`, score ?? "");
          if (val === null) return;
          const num = Number(String(val).replace(",", "."));
          if (!Number.isFinite(num)){ alert("Ange ett tal, tack."); return; }
          ev.scores[pi] = num; render();
        }});
      clickable.append(
        el('div', {class:'tri score', title:'Resultat'}, fmt(score)),
        el('div', {class:'tri rank', title:'Placeringspoäng'}, fmt(pts[pi]))
      );
      cell.append(clickable);
      tr.append(cell);
    }
    tbody.append(tr);
  });

  // TFOOT totalsumma
  const tfoot = el('tfoot');
  const fr = el('tr');
  fr.append(el('th',{}, "Total placeringspoäng"));
  const totals = new Array(playerCount).fill(0);
  state.events.forEach(ev=>{
    const rp = rankPoints(ev, playerCount);
    rp.forEach((p,i)=>{ if (typeof p==='number') totals[i]+=p; });
  });
  totals.forEach(t => fr.append(el('td', {class:'total'}, fmt(t))));
  tfoot.append(fr);

  board.append(thead, tbody, tfoot);

  setStickTop(); // uppdatera sticky-offset (mobil)
}

/* -------------------- Controls -------------------- */
document.getElementById('addPlayer').addEventListener('click', ()=>{
  const next = `Spelare ${state.players.length+1}`;
  state.players.push(next);
  state.events.forEach(ev=>ev.scores.push(null));
  render();
});
document.getElementById('addEvent').addEventListener('click', ()=>{
  state.events.push({name:`Gren ${state.events.length+1}`, mode:'max', scores:Array(state.players.length).fill(null)});
  render();
});
document.getElementById('resetScores').addEventListener('click', ()=>{
  if (!confirm("Nollställa alla resultat?")) return;
  state.events.forEach(ev=>ev.scores.fill(null));
  render();
});
document.getElementById('renameSet').addEventListener('input', (e)=>{
  state.title = e.target.value;
});

// Init
render();
</script>
</body>
</html>
